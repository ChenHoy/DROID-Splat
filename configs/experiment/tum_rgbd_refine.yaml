# @package _global_
# Make sure we use the tum configuration
defaults:
  - override /data: TUM_RGBD/fr1
  - override /tracking: tum
  - override /mapping: tum

mode: rgbd
stride: 1
evaluate: True
run_mapping_gui: False
run_mapping: True
backend_every: 10

data:
  input_folder: /media/data/tum_rgbd/benchmark_rgbd/fr1_room

mapping:
  warmup: 10

  opt_params:
    position_lr_init: 1e-3 # Default MonoGS: 0.00016 (RGB mode has x10)
    position_lr_final: 1e-5 # Default MonoGS: 0.0000016
    position_lr_max_steps: 50 # Default MonoGS: 30000

  input:
    pcd_downsample_init: 16 # This is a constant downsampling factor
    pcd_downsample: 8 # You ideally have ~5-10k points per frame
    point_size: 0.02

  refinement:
    iters: 50 # Final Optimization iterations for all views
    optimize_poses: True
    random_subset: 0.2 # Always optimize over a random subset of frames with size % of all to save compute
    w_importance_sampling: True # Use importance sampling for the final optimization
    use_non_keyframes: False # Use non-keyframes during map refinement
    keyframes_at_least: 0.2 # Always make sure to have > x% keyframes in a batch
    densify_until: 0 # Dont densify/prune after this many iterations, ALL gaussians are well optimized
    bs: 10 # Batch size for refinement (Use <= 70 to avoid OOM!)
    lr_factor: 1

  online_opt:
    iters: 50 # Optimization iterations for selected views

    densify:

      vanilla:
        max_grad: 0.0005 # Gaussians with gradients above this are split (smaller -> denser)
        extent: 5  # Gaussians with scale smaller than self.percent_dense * extent get cloned (bigger -> denser)
        min_opacity: 0.05 # Gaussians with opacity lower than this get pruned (bigger -> more pruning)
        max_screen_size: 15 # Gaussians with radius bigger than this get pruned (smaller -> more pruning)
        scale_std: 0.25 # How much variance when perturbating old Gaussians during densify_and_split()

      use_opacity: False # Use opacity based densification

      opacity:
        after: 0
        th: 0.5

    filter: # Parameter for filtering incoming points from the SLAM system
      multiview: True # Only initialize Gaussians that are consistent in multiple views
      uncertainty: False # Only use very certain points for intializing Gaussians
      mv_count_th: 2 # Pixels need to be consistent within bin_thresh distance across these k views
      bin_th: 0.05 # Distance between points for binning, this depends on the scene scale, so be careful!
      conf_th: 0.25 # Only take pixels above this confidence (Usually dynamic objects and obvious unuseful pixels like sky are below 0.1)

    pruning:
      mode: "new" # ["abs", "new"] How to prune: either check for covisible frames everywhere or just in the last n frames
      last: 10 # Prune only Gaussians added during the last k frames (Hint: this needs to be <= n_last_frames)
      dont_prune_latest: 0 # Never prune the latest Gaussians as this leads to unnecessary add / delete
      visibility_th: 2 # Gaussians not visible by at least this many frames are pruned 

  loss:
    beta1: 5